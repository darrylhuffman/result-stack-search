import { useState } from 'react'
import Head from 'next/head'
import styles from '../styles/Home.module.scss'

import Searchbar from '../components/Searchbar'
import UserResult from '../components/UserResult'

import Footer from '../components/Footer'
import { GoChevronLeft, GoChevronRight } from 'react-icons/go'

export default function Home() {
	const [searchTerm, setSearchTerm] = useState(''),
		[ results, setResults] = useState({ page: 1, users: [], total_count: 1 }),
		pageCount = 30,
		numPages = Math.ceil(results.total_count / pageCount)

	function inputComplete(value){
		if(value == '') return;
		setSearchTerm(value)
		preformSearch({ query: value, page: 1 })
	}

	function preformSearch({ query, page = 1 }){
		if(!query) query = searchTerm
		console.log(searchTerm, page)
		fetch(`https://api.github.com/search/users?q=${encodeURIComponent(query)}&page=${page}&per_page=${pageCount}`, {
			method: 'get',
			headers: {
			  'Accept': 'application/json',
			  'Content-Type': 'application/json'
			}
		})
		.then(r => r.json())
		.then(r => {
			console.log(r)
			setResults({ page, users: r.items, total_count: r.total_count })
		})
	}

	return (
		<div className={styles.container}>
			<Head>
				<title>User Search - ResultStack Interview Prompt</title>
				<meta name="description" content="Generated by create next app" />
				<link rel="icon" href="/favicon.ico" />
			</Head>

			<main className={styles.main}>
				<h1 className={styles.title}>
					GitHub User Search
				</h1>

				<Searchbar onChange={value => inputComplete(value)} />

				{results.users && (
					<>
						<div className={styles.userResults}>
							{results.users.map(user => <UserResult user={user} key={user.login} />)}
						</div>

						{results.users.length > 0 && (<div className={styles.pagination}>
							{results.page > 1 && <div className={styles.paginationButton} onClick={() => { preformSearch({ page: results.page - 1 }) }}><GoChevronLeft /></div>}
							Page {results.page} of {numPages}
							{results.page < results.total_count && <div className={styles.paginationButton} onClick={() => { preformSearch({ page: results.page + 1 }) }}><GoChevronRight /></div>}
						</div>)}
					</>
				)}

				
			</main>

			<Footer />
		</div>
	)
}
